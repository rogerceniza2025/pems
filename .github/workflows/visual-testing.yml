name: Visual Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'
  PERCY_PARALLEL_TOTAL: 4
  PERCY_PARALLEL_NONCE: ${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  visual-testing:
    name: Visual Regression Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pems_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup environment variables
        run: |
          echo "TEST_BASE_URL=http://localhost:3000" >> $GITHUB_ENV
          echo "STORYBOOK_URL=http://localhost:6006" >> $GITHUB_ENV
          echo "PERCY_BRANCH=${{ github.head_ref || github.ref_name }}" >> $GITHUB_ENV
          echo "PERCY_TARGET_BRANCH=main" >> $GITHUB_ENV
          echo "PERCY_PULL_REQUEST=${{ github.event.number }}" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV
          echo "NODE_ENV=test" >> $GITHUB_ENV

      - name: Setup Percy
        if: github.event_name != 'push' || github.ref == 'refs/heads/main'
        run: |
          if [ -n "$PERCY_TOKEN" ]; then
            echo "‚úÖ Percy token found - visual snapshots will be uploaded"
            echo "üìä Percy Branch: $PERCY_BRANCH"
            echo "üéØ Target Branch: $PERCY_TARGET_BRANCH"
          else
            echo "‚ö†Ô∏è Percy token not found - visual snapshots will be captured locally only"
          fi
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

      - name: Build application
        run: pnpm build

      - name: Build Storybook
        run: pnpm build-storybook

      - name: Start application
        run: |
          pnpm dev &
          sleep 10

      - name: Wait for application to be ready
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/health; do sleep 2; done'
          echo "‚úÖ Application is ready"

      - name: Start Storybook
        run: |
          npx http-server storybook-static -p 6006 &
          sleep 5

      - name: Wait for Storybook to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:6006; do sleep 2; done'
          echo "‚úÖ Storybook is ready"

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Run cross-browser visual tests
        run: pnpm test:visual:cross-browser
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          PERCY_PARALLEL_NONCE: ${{ env.PERCY_PARALLEL_NONCE }}-1

      - name: Run responsive design visual tests
        run: pnpm test:visual:responsive
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          PERCY_PARALLEL_NONCE: ${{ env.PERCY_PARALLEL_NONCE }}-2

      - name: Run theme consistency visual tests
        run: pnpm test:visual:themes
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          PERCY_PARALLEL_NONCE: ${{ env.PERCY_PARALLEL_NONCE }}-3

      - name: Run Storybook component visual tests
        run: pnpm test:visual:storybook
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          PERCY_PARALLEL_NONCE: ${{ env.PERCY_PARALLEL_NONCE }}-4

      - name: Run critical user journey visual tests
        run: pnpm test:visual:critical
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-results
          path: |
            test-results/
            playwright-report/
            visual-test-report.json
          retention-days: 7

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-test-screenshots
          path: test-results/screenshots/
          retention-days: 7

      - name: Generate visual test summary
        if: always()
        run: |
          echo "## üé® Visual Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "visual-test-report.json" ]; then
            echo "### üìä Test Results" >> $GITHUB_STEP_SUMMARY

            # Extract summary from report if it exists
            if command -v jq >/dev/null 2>&1; then
              PASSED=$(jq -r '.summary.passedTests // 0' visual-test-report.json)
              FAILED=$(jq -r '.summary.failedTests // 0' visual-test-report.json)
              TOTAL=$(jq -r '.summary.totalTests // 0' visual-test-report.json)

              echo "- ‚úÖ **Passed**: $PASSED" >> $GITHUB_STEP_SUMMARY
              echo "- ‚ùå **Failed**: $FAILED" >> $GITHUB_STEP_SUMMARY
              echo "- üìä **Total**: $TOTAL" >> $GITHUB_STEP_SUMMARY

              if [ "$FAILED" -gt 0 ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ‚ö†Ô∏è Failed Tests" >> $GITHUB_STEP_SUMMARY
                echo "Review the failed visual tests in the Percy dashboard or check the uploaded artifacts." >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- Visual test report generated (view artifacts for details)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- Visual tests completed (view artifacts for detailed results)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Percy Dashboard" >> $GITHUB_STEP_SUMMARY
          if [ -n "$PERCY_TOKEN" ]; then
            echo "[View Visual Comparison in Percy](https://percy.io/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "Percy integration not configured - view local screenshots in artifacts" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Percy finalization
        if: always() && github.event_name != 'push' || github.ref == 'refs/heads/main'
        run: |
          if [ -n "$PERCY_TOKEN" ]; then
            echo "üéØ Finalizing Percy build..."
            npx percy build:finalize ${{ secrets.PERCY_TOKEN }} || true
          fi
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

  visual-testing-matrix:
    name: Visual Tests Matrix
    runs-on: ubuntu-latest
    needs: visual-testing
    if: github.event_name == 'pull_request'

    strategy:
      fail-fast: false
      matrix:
        test-group: [critical, responsive, themes, storybook]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Setup environment
        run: |
          echo "TEST_BASE_URL=http://localhost:3000" >> $GITHUB_ENV
          echo "STORYBOOK_URL=http://localhost:6006" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV

      - name: Build application
        run: pnpm build

      - name: Start services
        run: |
          pnpm dev &
          npx http-server storybook-static -p 6006 &
          sleep 15

      - name: Run specific visual test group
        run: pnpm test:visual:${{ matrix.test-group }}
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

      - name: Upload group results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-test-results-${{ matrix.test-group }}
          path: test-results/
          retention-days: 3

  visual-review-notification:
    name: Visual Review Notification
    runs-on: ubuntu-latest
    needs: [visual-testing, visual-testing-matrix]
    if: always() && github.event_name == 'pull_request' && needs.visual-testing.result == 'failure'

    steps:
      - name: Notify on visual test failures
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Comment on PR with visual test results
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: `## üé® Visual Regression Test Results

            ‚ùå **Visual tests failed!** Some UI changes were detected that need review.

            ### üîç Next Steps:
            1. Review the failed visual tests in the [Percy Dashboard](https://percy.io/${{ github.repository }})
            2. Check the uploaded artifacts for detailed screenshots
            3. If changes are intentional, approve them in Percy
            4. If changes are unintentional, fix the UI issues

            ### üìã Failed Test Groups:
            - Check the workflow run logs for specific failures
            - Download test result artifacts for detailed analysis

            ---
            *This comment was automatically generated by visual testing workflow.*`
            });