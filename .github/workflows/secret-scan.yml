name: Secret Detection

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  gitguardian-scan:
    name: GitGuardian Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: GitGuardian scan
        id: ggshield
        uses: GitGuardian/ggshield-action@v1.30.0
        env:
          GGUARDIAN_API_KEY: ${{ secrets.GGUARDIAN_API_KEY }}
          GITHUB_WORKFLOW: true
          GITGUARDIAN_API_URL: "https://api.gitguardian.com"
        with:
          args: 'scan ci'

      - name: Upload GitGuardian results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitguardian-results
          path: |
            gitguardian-reports/
            ggshield-output.json
          retention-days: 30

      - name: Secret scan summary
        if: always()
        run: |
          echo "## ðŸ”’ Secret Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.ggshield.outcome }}" == "failure" ]; then
            echo "âŒ **Secrets detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš¨ Critical Issues" >> $GITHUB_STEP_SUMMARY
            echo "- Review the GitGuardian dashboard for details" >> $GITHUB_STEP_SUMMARY
            echo "- Remove secrets before merging" >> $GITHUB_STEP_SUMMARY
            echo "- Rotate any exposed credentials immediately" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ”— GitGuardian Dashboard" >> $GITHUB_STEP_SUMMARY
            echo "[View Full Report](https://dashboard.gitguardian.com/workspace)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No secrets detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The codebase passed GitGuardian's security scan." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Block merge on secrets
        if: steps.ggshield.outcome == 'failure'
        run: |
          echo "::error::Secrets detected in the codebase. Please remove them before merging."
          exit 1

  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '1'
          severity: 'HIGH,CRITICAL'

      - name: Upload Trivy scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: trivy-scan

      - name: Trivy scan summary
        if: always()
        run: |
          echo "## ðŸ” Trivy Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "trivy-results.sarif" ]; then
            VULNS=$(jq '.results | length' trivy-results.sarif 2>/dev/null || echo "0")
            echo "ðŸ“Š **Vulnerabilities Found:** $VULNS" >> $GITHUB_STEP_SUMMARY

            if [ "$VULNS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸš¨ Critical & High Severity Issues" >> $GITHUB_STEP_SUMMARY
              echo "- Review the Trivy results for details" >> $GITHUB_STEP_SUMMARY
              echo "- Update dependencies to secure versions" >> $GITHUB_STEP_SUMMARY
              echo "- Address any critical security issues" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… No critical or high severity vulnerabilities found." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ Trivy scan results not available." >> $GITHUB_STEP_SUMMARY
          fi

  gitleaks-scan:
    name: Gitleaks Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          verbose: true
          config_file: '.gitleaks.toml'

      - name: Gitleaks summary
        if: always()
        run: |
          echo "## ðŸ” Gitleaks Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "gitleaks-report.json" ]; then
            SECRETS=$(jq '.summary.leaksFound' gitleaks-report.json 2>/dev/null || echo "0")
            echo "ðŸ“Š **Secrets Found:** $SECRETS" >> $GITHUB_STEP_SUMMARY

            if [ "$SECRETS" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸš¨ Secrets Detected by Gitleaks" >> $GITHUB_STEP_SUMMARY
              echo "- Check the Gitleaks report for details" >> $GITHUB_STEP_SUMMARY
              echo "- Remove or properly secure detected secrets" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… No secrets detected by Gitleaks." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ Gitleaks report not available." >> $GITHUB_STEP_SUMMARY
          fi

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Audit dependencies
        run: pnpm audit --audit-level moderate

      - name: Snyk vulnerability scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Dependency audit summary
        if: always()
        run: |
          echo "## ðŸ“¦ Dependency Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run audit and capture results
          AUDIT_OUTPUT=$(pnpm audit --json 2>/dev/null || echo '{"vulnerabilities": {}}')
          VULNS=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.total // 0' 2>/dev/null || echo "0")
          HIGH_VULNS=$(echo "$AUDIT_OUTPUT" | jq -r '.vulnerabilities | map(select(.severity == "high" or .severity == "critical")) | length' 2>/dev/null || echo "0")

          echo "ðŸ“Š **Total Vulnerabilities:** $VULNS" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš¨ **High/Critical Severity:** $HIGH_VULNS" >> $GITHUB_STEP_SUMMARY

          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš¨ High/Critical Vulnerabilities Found" >> $GITHUB_STEP_SUMMARY
            echo "- Update affected dependencies to secure versions" >> $GITHUB_STEP_SUMMARY
            echo "- Review the full audit report for details" >> $GITHUB_STEP_SUMMARY
            echo "- Consider using \`pnpm audit fix\` where possible" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… No high or critical severity vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi

  pre-commit-scan:
    name: Pre-commit Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install pre-commit tools
        run: |
          pip install pre-commit
          pip install gitpython

      - name: Run security pre-commit hooks
        run: |
          # Install pre-commit hooks
          pre-commit install

          # Run only security-related hooks
          pre-commit run --all-files \
            detect-aws-credentials \
            detect-private-key \
            check-json \
            check-yaml \
            check-merge-conflict \
            trailing-whitespace

      - name: Pre-commit security summary
        if: always()
        run: |
          echo "## ðŸ”’ Pre-commit Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "âœ… Pre-commit security hooks executed successfully." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Security checks performed:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AWS credentials detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Private key detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… JSON/YAML syntax validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Merge conflict detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trailing whitespace cleanup" >> $GITHUB_STEP_SUMMARY

  security-compliance-check:
    name: Security Compliance Check
    runs-on: ubuntu-latest
    needs: [gitguardian-scan, trivy-scan, gitleaks-scan, dependency-audit]

    steps:
      - name: Overall security status
        run: |
          echo "## ðŸ›¡ï¸ Overall Security Compliance Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check status of all security scans
          GITGUARDIAN_STATUS="${{ needs.gitguardian-scan.result }}"
          TRIVY_STATUS="${{ needs.trivy-scan.result }}"
          GITLEAKS_STATUS="${{ needs.gitleaks-scan.result }}"
          DEPS_STATUS="${{ needs.dependency-audit.result }}"

          ALL_PASSED=true

          echo "### ðŸ“Š Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ **GitGuardian:** $GITGUARDIAN_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Trivy:** $TRIVY_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Gitleaks:** $GITLEAKS_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ **Dependency Audit:** $DEPS_STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "$GITGUARDIAN_STATUS" != "success" ]; then
            ALL_PASSED=false
            echo "âŒ **GitGuardian scan failed** - Secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$TRIVY_STATUS" != "success" ]; then
            ALL_PASSED=false
            echo "âŒ **Trivy scan failed** - Critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$GITLEAKS_STATUS" != "success" ]; then
            ALL_PASSED=false
            echo "âŒ **Gitleaks scan failed** - Secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$DEPS_STATUS" != "success" ]; then
            ALL_PASSED=false
            echo "âŒ **Dependency audit failed** - High severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$ALL_PASSED" = true ]; then
            echo "âœ… **ALL SECURITY CHECKS PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "The codebase meets security compliance requirements." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **SECURITY COMPLIANCE FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Address the security issues before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Generate security report
        if: always()
        run: |
          # Generate comprehensive security report
          cat > security-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "scan_results": {
              "gitguardian": "${{ needs.gitguardian-scan.result }}",
              "trivy": "${{ needs.trivy-scan.result }}",
              "gitleaks": "${{ needs.gitleaks-scan.result }}",
              "dependencies": "${{ needs.dependency-audit.result }}"
            },
            "compliance": {
              "passed": $([ "${{ needs.gitguardian-scan.result }}" = "success" ] && \
                       [ "${{ needs.trivy-scan.result }}" = "success" ] && \
                       [ "${{ needs.gitleaks-scan.result }}" = "success" ] && \
                       [ "${{ needs.dependency-audit.result }}" = "success" ] && echo "true" || echo "false")
            },
            "tools": {
              "gitguardian": {
                "enabled": true,
                "dashboard": "https://dashboard.gitguardian.com/workspace"
              },
              "trivy": {
                "enabled": true,
                "scanner": "https://github.com/aquasecurity/trivy"
              },
              "gitleaks": {
                "enabled": true,
                "scanner": "https://github.com/zricethezav/gitleaks"
              },
              "snyk": {
                "enabled": true,
                "dashboard": "https://snyk.io"
              }
            }
          }
          EOF

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-compliance-report
          path: security-report.json
          retention-days: 90